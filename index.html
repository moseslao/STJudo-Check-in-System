<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é“å ´å°STJudo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
        }
        
        body {
            background: #ffffff;
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            background-color: #ffffff;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            border: 1px solid #e0e0e0;
        }
        
        header {
            background: linear-gradient(90deg, #2c3e50, #4a6491);
            color: white;
            padding: 25px;
            text-align: center;
            border-bottom: 5px solid #3498db;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            font-size: 1.2rem;
            opacity: 0.9;
        }
        
        .main-content {
            display: flex;
            flex-wrap: wrap;
            padding: 20px;
            background: #ffffff;
        }
        
        .card-section {
            flex: 1;
            min-width: 350px;
            padding: 20px;
            border-right: 1px solid #e0e0e0;
        }
        
        .records-section {
            flex: 2;
            min-width: 500px;
            padding: 20px;
        }
        
        .calendar-section {
            flex: 1;
            min-width: 400px;
            padding: 20px;
            border-left: 1px solid #e0e0e0;
        }
        
        .card-reader {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 25px;
            border: 2px dashed #3498db;
        }
        
        .card-reader h2 {
            color: #2c3e50;
            margin-bottom: 15px;
        }
        
        .card-icon {
            font-size: 4rem;
            color: #3498db;
            margin: 20px 0;
        }
        
        .status {
            font-size: 1.2rem;
            padding: 10px;
            margin: 15px 0;
            border-radius: 5px;
            background-color: #e8f4fc;
            color: #2c3e50;
            min-height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            margin: 5px;
        }
        
        .btn:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .btn-register {
            background: #2ecc71;
        }
        
        .btn-register:hover {
            background: #27ae60;
        }
        
        .btn-location {
            background: #9b59b6;
        }
        
        .btn-location:hover {
            background: #8e44ad;
        }
        
        .btn-calendar {
            background: #e67e22;
        }
        
        .btn-calendar:hover {
            background: #d35400;
        }
        
        .btn-admin {
            background: #e74c3c;
        }
        
        .btn-admin:hover {
            background: #c0392b;
        }
        
        .btn-start {
            background: #2ecc71;
        }
        
        .btn-start:hover {
            background: #27ae60;
        }
        
        .btn-stop {
            background: #e74c3c;
        }
        
        .btn-stop:hover {
            background: #c0392b;
        }
        
        .system-status {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            text-align: center;
        }
        
        .system-status h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        
        .status-active {
            background: #2ecc71;
        }
        
        .status-inactive {
            background: #e74c3c;
        }
        
        .form-group {
            margin: 15px 0;
            text-align: left;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            background: #ffffff;
        }
        
        .card-input {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .card-input h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .records-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .records-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .records-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #eee;
            background: #ffffff;
        }
        
        .records-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .records-table tr:hover {
            background-color: #e8f4fc;
        }
        
        .time-in {
            color: #2ecc71;
            font-weight: bold;
        }
        
        .time-out {
            color: #e74c3c;
            font-weight: bold;
        }
        
        .location {
            color: #9b59b6;
            font-weight: bold;
        }
        
        .card-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .card-info h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            text-align: center;
        }
        
        .stat-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            flex: 1;
            margin: 0 10px;
            border: 1px solid #e0e0e0;
        }
        
        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .stat-label {
            color: #7f8c8d;
            margin-top: 5px;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            background: #2c3e50;
            color: white;
            margin-top: 20px;
        }
        
        .location-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .location-info h3 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .location-movement {
            color: #e67e22;
            font-weight: bold;
            margin-top: 10px;
            padding: 8px;
            background: #fef9e7;
            border-radius: 5px;
            text-align: center;
        }
        
        .calendar-container {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            margin-bottom: 20px;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }
        
        .calendar-day-header {
            text-align: center;
            font-weight: bold;
            padding: 10px;
            background: #3498db;
            color: white;
            border-radius: 5px;
        }
        
        .calendar-day {
            text-align: center;
            padding: 10px;
            background: white;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid #e0e0e0;
        }
        
        .calendar-day:hover {
            background: #e8f4fc;
            transform: scale(1.05);
        }
        
        .calendar-day.active {
            background: #3498db;
            color: white;
        }
        
        .calendar-day.has-records {
            background: #2ecc71;
            color: white;
        }
        
        .calendar-day.weekend {
            background: #f8d7da;
        }
        
        .calendar-day.other-month {
            color: #ccc;
            background: #f8f9fa;
        }
        
        .day-details {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .day-details h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }
        
        .day-summary {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .summary-box {
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            flex: 1;
            margin: 0 5px;
            border: 1px solid #e0e0e0;
        }
        
        .summary-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3498db;
        }
        
        .summary-label {
            color: #7f8c8d;
            font-size: 0.8rem;
            margin-top: 5px;
        }
        
        .day-records {
            max-height: 300px;
            overflow-y: auto;
        }
        
        .day-record-item {
            display: flex;
            justify-content: space-between;
            padding: 8px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .day-record-item:nth-child(even) {
            background: #f8f9fa;
        }
        
        .admin-panel {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
        }
        
        .admin-panel h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            border-bottom: 2px solid #e74c3c;
            padding-bottom: 10px;
        }
        
        .cards-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            border-radius: 5px;
            overflow: hidden;
        }
        
        .cards-table th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
        }
        
        .cards-table td {
            padding: 10px 12px;
            border-bottom: 1px solid #eee;
            background: white;
        }
        
        .cards-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .cards-table tr:hover {
            background-color: #e8f4fc;
        }
        
        @media (max-width: 1200px) {
            .main-content {
                flex-direction: column;
            }
            
            .card-section, .calendar-section {
                border-right: none;
                border-bottom: 1px solid #e0e0e0;
                border-left: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>é“å ´å°STJudo</h1>
            <p class="subtitle">è¨˜éŒ„å­¸å“¡æ‰“å¡æ™‚é–“èˆ‡åœ°é»ç§»å‹•è»Œè·¡</p>
        </header>
        
        <div class="main-content">
            <div class="card-section">
                <div class="system-status">
                    <h3>ç³»çµ±ç‹€æ…‹</h3>
                    <div id="systemStatus">
                        <span class="status-indicator status-inactive"></span>
                        <span>ç³»çµ±æœªå•Ÿå‹•</span>
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-start" id="startSystem">å•Ÿå‹•æ‰“å¡ç³»çµ±</button>
                        <button class="btn btn-stop" id="stopSystem" disabled>çµæŸæ‰“å¡ç³»çµ±</button>
                    </div>
                </div>
                
                <div class="card-reader">
                    <h2>å¡ç‰‡è®€å–å€åŸŸ</h2>
                    <div class="card-icon">ğŸ’³</div>
                    <div class="status" id="status">ç³»çµ±æœªå•Ÿå‹•ï¼Œè«‹å…ˆå•Ÿå‹•ç³»çµ±</div>
                    
                    <div class="card-input">
                        <h3>è¼¸å…¥å¡ç‰‡ID</h3>
                        <div class="form-group">
                            <label for="cardInput">å¡ç‰‡ID:</label>
                            <input type="text" id="cardInput" placeholder="è«‹è¼¸å…¥å¡ç‰‡ID" autocomplete="off">
                        </div>
                        <button class="btn" id="processCardBtn">ç¢ºèªæ‰“å¡</button>
                    </div>
                    
                    <div class="location-info">
                        <h3>ç•¶å‰åœ°é»è¨­ç½®</h3>
                        <div class="form-group">
                            <label for="currentLocation">æ‰“å¡åœ°é»:</label>
                            <select id="currentLocation">
                                <option value="è‡ªä¿®å®¤">è‡ªä¿®å®¤</option>
                                <option value="æŸ”é“å ´">æŸ”é“å ´</option>
                            </select>
                        </div>
                    </div>
                    
                    <button class="btn btn-register" id="registerCard">è¨»å†Šæ–°å¡</button>
                    <button class="btn btn-admin" id="adminPanel">å¾Œå°ç®¡ç†</button>
                </div>
                
                <div class="card-info">
                    <h3>å¡ç‰‡è³‡è¨Š</h3>
                    <div class="form-group">
                        <label for="cardId">å¡ç‰‡ID:</label>
                        <input type="text" id="cardId" placeholder="åˆ·å¡å¾Œè‡ªå‹•é¡¯ç¤º" readonly>
                    </div>
                    <div class="form-group">
                        <label for="userName">æŒå¡äººå§“å:</label>
                        <input type="text" id="userName" placeholder="åˆ·å¡å¾Œè‡ªå‹•é¡¯ç¤º" readonly>
                    </div>
                    <div class="form-group">
                        <label for="userRole">èº«ä»½:</label>
                        <input type="text" id="userRole" placeholder="åˆ·å¡å¾Œè‡ªå‹•é¡¯ç¤º" readonly>
                    </div>
                    <div class="form-group">
                        <label for="lastAction">æœ€å¾Œæ“ä½œ:</label>
                        <input type="text" id="lastAction" placeholder="åˆ·å¡å¾Œè‡ªå‹•é¡¯ç¤º" readonly>
                    </div>
                    <div class="form-group">
                        <label for="lastLocation">æœ€å¾Œåœ°é»:</label>
                        <input type="text" id="lastLocation" placeholder="åˆ·å¡å¾Œè‡ªå‹•é¡¯ç¤º" readonly>
                    </div>
                    <div class="form-group">
                        <label for="lastTime">æœ€å¾Œæ™‚é–“:</label>
                        <input type="text" id="lastTime" placeholder="åˆ·å¡å¾Œè‡ªå‹•é¡¯ç¤º" readonly>
                    </div>
                </div>
                
                <div class="stats">
                    <div class="stat-box">
                        <div class="stat-number" id="totalCards">0</div>
                        <div class="stat-label">å·²è¨»å†Šå¡ç‰‡</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-number" id="presentToday">0</div>
                        <div class="stat-label">ä»Šæ—¥ç°½åˆ°</div>
                    </div>
                </div>
                
                <div class="admin-panel" id="adminPanelSection" style="display: none;">
                    <h3>å¡ç‰‡ç®¡ç†å¾Œå°</h3>
                    <div class="cards-table-container">
                        <table class="cards-table">
                            <thead>
                                <tr>
                                    <th>å¡ç‰‡ID</th>
                                    <th>å§“å</th>
                                    <th>èº«ä»½</th>
                                    <th>æ“ä½œ</th>
                                </tr>
                            </thead>
                            <tbody id="cardsTableBody">
                                <!-- å¡ç‰‡è³‡æ–™å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <div class="records-section">
                <h2>æ‰“å¡è¨˜éŒ„</h2>
                <div class="form-group">
                    <label for="filterDate">ç¯©é¸æ—¥æœŸ:</label>
                    <input type="date" id="filterDate">
                </div>
                
                <table class="records-table">
                    <thead>
                        <tr>
                            <th>å§“å</th>
                            <th>èº«ä»½</th>
                            <th>ç°½åˆ°æ™‚é–“</th>
                            <th>ç°½é€€æ™‚é–“</th>
                            <th>åœ°é»</th>
                            <th>ç‹€æ…‹</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- è¨˜éŒ„å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
                    </tbody>
                </table>
            </div>
            
            <div class="calendar-section">
                <div class="calendar-container">
                    <h2>æ—¥æ›†æŸ¥è©¢</h2>
                    <div class="calendar-header">
                        <button class="btn btn-calendar" id="prevMonth">ä¸Šå€‹æœˆ</button>
                        <h3 id="currentMonth">2023å¹´11æœˆ</h3>
                        <button class="btn btn-calendar" id="nextMonth">ä¸‹å€‹æœˆ</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <!-- æ—¥æ›†å°‡é€šéJavaScriptå‹•æ…‹ç”Ÿæˆ -->
                    </div>
                </div>
                
                <div class="day-details">
                    <h3 id="selectedDateTitle">é¸æ“‡æ—¥æœŸæŸ¥çœ‹è©³æƒ…</h3>
                    <div class="day-summary">
                        <div class="summary-box">
                            <div class="summary-number" id="dayTotal">0</div>
                            <div class="summary-label">ç¸½æ‰“å¡æ¬¡æ•¸</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-number" id="dayPresent">0</div>
                            <div class="summary-label">ç°½åˆ°äººæ•¸</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-number" id="dayLocations">0</div>
                            <div class="summary-label">åœ°é»æ•¸é‡</div>
                        </div>
                    </div>
                    <div class="day-records" id="dayRecords">
                        <!-- ç•¶æ—¥è¨˜éŒ„å°‡é€šéJavaScriptå‹•æ…‹æ·»åŠ  -->
                    </div>
                </div>
            </div>
        </div>
        
        <footer>
            <p>é“å ´å°STJudo &copy; 2025 - è¨˜éŒ„å­¸å“¡ç§»å‹•è»Œè·¡</p>
        </footer>
    </div>

    <!-- è¨»å†Šæ–°å¡æ¨¡æ…‹æ¡† -->
    <div id="registerModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">è¨»å†Šæ–°å¡ç‰‡</h2>
            <div class="form-group">
                <label for="newCardId">å¡ç‰‡ID:</label>
                <input type="text" id="newCardId" placeholder="è«‹è¼¸å…¥å¡ç‰‡ID">
            </div>
            <div class="form-group">
                <label for="newUserName">æŒå¡äººå§“å:</label>
                <input type="text" id="newUserName" placeholder="è«‹è¼¸å…¥å§“å">
            </div>
            <div class="form-group">
                <label for="newUserRole">èº«ä»½:</label>
                <select id="newUserRole">
                    <option value="å­¸å“¡">å­¸å“¡</option>
                    <option value="å§”å“¡">å§”å“¡</option>
                    <option value="å°å¸«">å°å¸«</option>
                </select>
            </div>
            <div style="margin-top: 25px; text-align: right;">
                <button class="btn" id="cancelRegister">å–æ¶ˆ</button>
                <button class="btn btn-register" id="confirmRegister">ç¢ºèªè¨»å†Š</button>
            </div>
        </div>
    </div>

    <!-- ç·¨è¼¯å¡ç‰‡æ¨¡æ…‹æ¡† -->
    <div id="editModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
        <div style="background: white; padding: 30px; border-radius: 10px; width: 90%; max-width: 500px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);">
            <h2 style="margin-bottom: 20px; color: #2c3e50;">ç·¨è¼¯å¡ç‰‡è³‡æ–™</h2>
            <div class="form-group">
                <label for="editCardId">å¡ç‰‡ID:</label>
                <input type="text" id="editCardId" readonly>
            </div>
            <div class="form-group">
                <label for="editUserName">æŒå¡äººå§“å:</label>
                <input type="text" id="editUserName">
            </div>
            <div class="form-group">
                <label for="editUserRole">èº«ä»½:</label>
                <select id="editUserRole">
                    <option value="å­¸å“¡">å­¸å“¡</option>
                    <option value="å§”å“¡">å§”å“¡</option>
                    <option value="å°å¸«">å°å¸«</option>
                </select>
            </div>
            <div style="margin-top: 25px; text-align: right;">
                <button class="btn" id="cancelEdit">å–æ¶ˆ</button>
                <button class="btn btn-register" id="confirmEdit">ç¢ºèªä¿®æ”¹</button>
                <button class="btn btn-admin" id="deleteCard">åˆªé™¤å¡ç‰‡</button>
            </div>
        </div>
    </div>

    <script>
        // å¾localStorageåŠ è¼‰æ•¸æ“šï¼Œå¦‚æœæ²’æœ‰å‰‡åˆå§‹åŒ–ç‚ºç©º
        let cardData = JSON.parse(localStorage.getItem('judoCardData')) || {};
        let attendanceRecords = JSON.parse(localStorage.getItem('judoAttendanceRecords')) || [];
        
        // ç³»çµ±ç‹€æ…‹
        let systemActive = false;
        
        // DOMå…ƒç´ 
        const statusEl = document.getElementById('status');
        const cardIdEl = document.getElementById('cardId');
        const userNameEl = document.getElementById('userName');
        const userRoleEl = document.getElementById('userRole');
        const lastActionEl = document.getElementById('lastAction');
        const lastLocationEl = document.getElementById('lastLocation');
        const lastTimeEl = document.getElementById('lastTime');
        const recordsBodyEl = document.getElementById('recordsBody');
        const registerCardBtn = document.getElementById('registerCard');
        const adminPanelBtn = document.getElementById('adminPanel');
        const adminPanelSection = document.getElementById('adminPanelSection');
        const registerModal = document.getElementById('registerModal');
        const cancelRegisterBtn = document.getElementById('cancelRegister');
        const confirmRegisterBtn = document.getElementById('confirmRegister');
        const newCardIdEl = document.getElementById('newCardId');
        const newUserNameEl = document.getElementById('newUserName');
        const newUserRoleEl = document.getElementById('newUserRole');
        const filterDateEl = document.getElementById('filterDate');
        const totalCardsEl = document.getElementById('totalCards');
        const presentTodayEl = document.getElementById('presentToday');
        const currentLocationEl = document.getElementById('currentLocation');
        const cardsTableBodyEl = document.getElementById('cardsTableBody');
        const systemStatusEl = document.getElementById('systemStatus');
        const startSystemBtn = document.getElementById('startSystem');
        const stopSystemBtn = document.getElementById('stopSystem');
        const cardInputEl = document.getElementById('cardInput');
        const processCardBtn = document.getElementById('processCardBtn');
        
        // ç·¨è¼¯æ¨¡æ…‹æ¡†å…ƒç´ 
        const editModal = document.getElementById('editModal');
        const editCardIdEl = document.getElementById('editCardId');
        const editUserNameEl = document.getElementById('editUserName');
        const editUserRoleEl = document.getElementById('editUserRole');
        const cancelEditBtn = document.getElementById('cancelEdit');
        const confirmEditBtn = document.getElementById('confirmEdit');
        const deleteCardBtn = document.getElementById('deleteCard');
        
        // æ—¥æ›†ç›¸é—œå…ƒç´ 
        const calendarGridEl = document.getElementById('calendarGrid');
        const currentMonthEl = document.getElementById('currentMonth');
        const prevMonthBtn = document.getElementById('prevMonth');
        const nextMonthBtn = document.getElementById('nextMonth');
        const selectedDateTitleEl = document.getElementById('selectedDateTitle');
        const dayTotalEl = document.getElementById('dayTotal');
        const dayPresentEl = document.getElementById('dayPresent');
        const dayLocationsEl = document.getElementById('dayLocations');
        const dayRecordsEl = document.getElementById('dayRecords');
        
        // è¨­ç½®é»˜èªæ—¥æœŸç‚ºä»Šå¤©
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        filterDateEl.value = todayStr;
        
        // æ—¥æ›†ç›¸é—œè®Šæ•¸
        let currentMonth = today.getMonth();
        let currentYear = today.getFullYear();
        let selectedDate = todayStr;

        // å·²è¨»å†Šå¡ç‰‡åˆ—è¡¨
        const registeredCards = new Set(Object.keys(cardData));
        
        // ä¿å­˜æ•¸æ“šåˆ°localStorage
        function saveData() {
            localStorage.setItem('judoCardData', JSON.stringify(cardData));
            localStorage.setItem('judoAttendanceRecords', JSON.stringify(attendanceRecords));
        }
        
        // æ›´æ–°ç³»çµ±ç‹€æ…‹é¡¯ç¤º
        function updateSystemStatus() {
            if (systemActive) {
                systemStatusEl.innerHTML = '<span class="status-indicator status-active"></span><span>ç³»çµ±é‹è¡Œä¸­ - å¯é€²è¡Œæ‰“å¡</span>';
                statusEl.textContent = "è«‹è¼¸å…¥å¡ç‰‡IDé€²è¡Œæ‰“å¡";
                startSystemBtn.disabled = true;
                stopSystemBtn.disabled = false;
                cardInputEl.disabled = false;
                processCardBtn.disabled = false;
            } else {
                systemStatusEl.innerHTML = '<span class="status-indicator status-inactive"></span><span>ç³»çµ±æœªå•Ÿå‹•</span>';
                statusEl.textContent = "ç³»çµ±æœªå•Ÿå‹•ï¼Œè«‹å…ˆå•Ÿå‹•ç³»çµ±";
                startSystemBtn.disabled = false;
                stopSystemBtn.disabled = true;
                cardInputEl.disabled = true;
                processCardBtn.disabled = true;
            }
        }
        
        // å•Ÿå‹•ç³»çµ±
        startSystemBtn.addEventListener('click', function() {
            systemActive = true;
            updateSystemStatus();
            statusEl.innerHTML = '<span style="color: #2ecc71;">ç³»çµ±å·²å•Ÿå‹•ï¼Œè«‹è¼¸å…¥å¡ç‰‡IDé€²è¡Œæ‰“å¡</span>';
            cardInputEl.focus();
        });
        
        // åœæ­¢ç³»çµ±
        stopSystemBtn.addEventListener('click', function() {
            systemActive = false;
            updateSystemStatus();
            statusEl.innerHTML = '<span style="color: #e74c3c;">ç³»çµ±å·²åœæ­¢ï¼Œç„¡æ³•æ‰“å¡</span>';
        });
        
        // æ›´æ–°çµ±è¨ˆæ•¸æ“š
        function updateStats() {
            totalCardsEl.textContent = Object.keys(cardData).length;
            
            const todayRecords = attendanceRecords.filter(record => 
                record.date === todayStr
            );
            
            const uniqueToday = [...new Set(todayRecords.map(record => record.cardId))];
            presentTodayEl.textContent = uniqueToday.length;
        }
        
        // è™•ç†åˆ·å¡ - æ ¹æ“šå¯¦éš›å¡ç‰‡IDè™•ç†
        function processCard(cardId) {
            if (!systemActive) {
                statusEl.innerHTML = '<span style="color: #e74c3c;">ç³»çµ±æœªå•Ÿå‹•ï¼Œç„¡æ³•æ‰“å¡</span>';
                return;
            }
            
            console.log("è™•ç†å¡ç‰‡ID:", cardId);
            
            // æª¢æŸ¥å¡ç‰‡æ˜¯å¦å·²è¨»å†Š
            if (registeredCards.has(cardId)) {
                // å·²è¨»å†Šå¡ç‰‡
                const user = cardData[cardId];
                const now = new Date();
                const currentTime = now.toLocaleTimeString('zh-TW');
                const currentDate = now.toISOString().split('T')[0];
                const currentLocation = currentLocationEl.value;
                
                // æ›´æ–°å¡ç‰‡ä¿¡æ¯é¡¯ç¤º
                cardIdEl.value = cardId;
                userNameEl.value = user.name;
                userRoleEl.value = user.role;
                
                // åˆ¤æ–·æ˜¯ç°½åˆ°é‚„æ˜¯ç°½é€€
                let action = "ç°½åˆ°";
                let timeClass = "time-in";
                
                // æª¢æŸ¥ç”¨æˆ¶æ˜¯å¦æœ‰æœªç°½é€€çš„è¨˜éŒ„
                const hasUnfinished = user.lastAction === "ç°½åˆ°" && user.lastTime && !user.lastTime.includes("ç°½é€€");
                
                if (hasUnfinished) {
                    action = "ç°½é€€";
                    timeClass = "time-out";
                }
                
                // æ›´æ–°æœ€å¾Œæ“ä½œä¿¡æ¯
                user.lastAction = action;
                user.lastTime = currentTime;
                user.lastLocation = currentLocation;
                
                lastActionEl.value = action;
                lastTimeEl.value = currentTime;
                lastLocationEl.value = currentLocation;
                
                // é¡¯ç¤ºåœ°é»ç§»å‹•ä¿¡æ¯
                let locationMovement = "";
                if (user.lastLocation && user.lastLocation !== currentLocation) {
                    locationMovement = `<div class="location-movement">å¾ ${user.lastLocation} ç§»å‹•åˆ° ${currentLocation}</div>`;
                }
                
                // æ›´æ–°ç‹€æ…‹é¡¯ç¤º
                statusEl.innerHTML = `
                    <div>
                        <span class="${timeClass}">${user.name} ${action}æˆåŠŸ - ${currentTime}</span>
                        <div class="location">åœ°é»: ${currentLocation}</div>
                        ${locationMovement}
                    </div>
                `;
                
                // æ·»åŠ æ‰“å¡è¨˜éŒ„
                const newRecord = {
                    cardId: cardId,
                    name: user.name,
                    role: user.role,
                    date: currentDate,
                    timeIn: action === "ç°½åˆ°" ? currentTime : user.lastTime,
                    timeOut: action === "ç°½é€€" ? currentTime : "",
                    location: currentLocation
                };
                
                attendanceRecords.unshift(newRecord);
                
                // ä¿å­˜æ•¸æ“šåˆ°localStorage
                saveData();
                
                // æ›´æ–°è¨˜éŒ„è¡¨æ ¼
                updateRecordsTable();
                updateStats();
                updateCalendar();
                updateDayDetails(selectedDate);
                
                // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦èšç„¦
                cardInputEl.value = '';
                cardInputEl.focus();
                
            } else {
                // æœªè¨»å†Šå¡ç‰‡
                cardIdEl.value = cardId;
                userNameEl.value = "æœªè¨»å†Š";
                userRoleEl.value = "---";
                lastActionEl.value = "æœªè¨»å†Šå¡ç‰‡";
                lastTimeEl.value = "---";
                lastLocationEl.value = "---";
                
                statusEl.innerHTML = `<span style="color: #e74c3c;">å¡ç‰‡ID: ${cardId} æœªè¨»å†Šï¼Œè«‹å…ˆè¨»å†Š</span>`;
                
                // æ¸…ç©ºè¼¸å…¥æ¡†ä¸¦èšç„¦
                cardInputEl.value = '';
                cardInputEl.focus();
            }
        }
        
        // ç¢ºèªæ‰“å¡æŒ‰éˆ•äº‹ä»¶
        processCardBtn.addEventListener('click', function() {
            const cardId = cardInputEl.value.trim();
            if (cardId) {
                processCard(cardId);
            } else {
                statusEl.innerHTML = '<span style="color: #e74c3c;">è«‹è¼¸å…¥å¡ç‰‡ID</span>';
                cardInputEl.focus();
            }
        });
        
        // æŒ‰Enteréµä¹Ÿå¯ä»¥æ‰“å¡
        cardInputEl.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') {
                processCardBtn.click();
            }
        });
        
        // æ›´æ–°è¨˜éŒ„è¡¨æ ¼
        function updateRecordsTable() {
            const filterDate = filterDateEl.value;
            const filteredRecords = attendanceRecords.filter(record => record.date === filterDate);
            
            recordsBodyEl.innerHTML = "";
            
            if (filteredRecords.length === 0) {
                recordsBodyEl.innerHTML = `<tr><td colspan="6" style="text-align: center;">æš«ç„¡è¨˜éŒ„</td></tr>`;
                return;
            }
            
            filteredRecords.forEach(record => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${record.name}</td>
                    <td>${record.role}</td>
                    <td class="time-in">${record.timeIn || '--:--:--'}</td>
                    <td class="time-out">${record.timeOut || '--:--:--'}</td>
                    <td class="location">${record.location}</td>
                    <td>${record.timeOut ? 'å·²ç°½é€€' : 'å·²ç°½åˆ°'}</td>
                `;
                
                recordsBodyEl.appendChild(row);
            });
        }
        
        // è¨»å†Šæ–°å¡
        registerCardBtn.addEventListener('click', function() {
            newCardIdEl.value = "";
            newUserNameEl.value = "";
            newUserRoleEl.value = "å­¸å“¡";
            registerModal.style.display = "flex";
        });
        
        // å–æ¶ˆè¨»å†Š
        cancelRegisterBtn.addEventListener('click', function() {
            registerModal.style.display = "none";
        });
        
        // ç¢ºèªè¨»å†Š
        confirmRegisterBtn.addEventListener('click', function() {
            const cardId = newCardIdEl.value.trim();
            const userName = newUserNameEl.value.trim();
            const userRole = newUserRoleEl.value;
            
            if (!cardId) {
                alert("è«‹è¼¸å…¥å¡ç‰‡ID");
                return;
            }
            
            if (!userName) {
                alert("è«‹è¼¸å…¥æŒå¡äººå§“å");
                return;
            }
            
            // æª¢æŸ¥å¡ç‰‡IDæ˜¯å¦å·²å­˜åœ¨
            if (registeredCards.has(cardId)) {
                alert("æ­¤å¡ç‰‡IDå·²è¨»å†Šï¼Œè«‹ä½¿ç”¨å…¶ä»–ID");
                return;
            }
            
            // æ·»åŠ åˆ°å¡ç‰‡æ•¸æ“š
            cardData[cardId] = {
                name: userName,
                role: userRole,
                lastAction: null,
                lastTime: null,
                lastLocation: null
            };
            
            // æ·»åŠ åˆ°å·²è¨»å†Šå¡ç‰‡åˆ—è¡¨
            registeredCards.add(cardId);
            
            // ä¿å­˜æ•¸æ“šåˆ°localStorage
            saveData();
            
            // é—œé–‰æ¨¡æ…‹æ¡†
            registerModal.style.display = "none";
            
            // æ›´æ–°ç‹€æ…‹
            statusEl.innerHTML = `<span style="color: #2ecc71;">å¡ç‰‡ ${cardId} è¨»å†ŠæˆåŠŸ - ${userName}</span>`;
            
            // æ›´æ–°çµ±è¨ˆæ•¸æ“š
            updateStats();
            updateCardsTable();
            
            // æ¸…ç©ºè¡¨å–®
            newCardIdEl.value = "";
            newUserNameEl.value = "";
            
            // èšç„¦åˆ°å¡ç‰‡è¼¸å…¥æ¡†
            cardInputEl.focus();
        });
        
        // å¾Œå°ç®¡ç†
        adminPanelBtn.addEventListener('click', function() {
            if (adminPanelSection.style.display === 'none') {
                adminPanelSection.style.display = 'block';
                updateCardsTable();
            } else {
                adminPanelSection.style.display = 'none';
            }
        });
        
        // æ›´æ–°å¡ç‰‡è¡¨æ ¼
        function updateCardsTable() {
            cardsTableBodyEl.innerHTML = '';
            
            Object.keys(cardData).forEach(cardId => {
                const user = cardData[cardId];
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${cardId}</td>
                    <td>${user.name}</td>
                    <td>${user.role}</td>
                    <td>
                        <button class="btn" data-card-id="${cardId}">ç·¨è¼¯</button>
                    </td>
                `;
                
                cardsTableBodyEl.appendChild(row);
            });
            
            // æ·»åŠ ç·¨è¼¯æŒ‰éˆ•äº‹ä»¶
            document.querySelectorAll('#cardsTableBody .btn').forEach(button => {
                button.addEventListener('click', function() {
                    const cardId = this.getAttribute('data-card-id');
                    openEditModal(cardId);
                });
            });
        }
        
        // æ‰“é–‹ç·¨è¼¯æ¨¡æ…‹æ¡†
        function openEditModal(cardId) {
            const user = cardData[cardId];
            editCardIdEl.value = cardId;
            editUserNameEl.value = user.name;
            editUserRoleEl.value = user.role;
            editModal.style.display = 'flex';
        }
        
        // å–æ¶ˆç·¨è¼¯
        cancelEditBtn.addEventListener('click', function() {
            editModal.style.display = 'none';
        });
        
        // ç¢ºèªç·¨è¼¯
        confirmEditBtn.addEventListener('click', function() {
            const cardId = editCardIdEl.value;
            const userName = editUserNameEl.value.trim();
            const userRole = editUserRoleEl.value;
            
            if (!userName) {
                alert("è«‹è¼¸å…¥æŒå¡äººå§“å");
                return;
            }
            
            // æ›´æ–°å¡ç‰‡æ•¸æ“š
            cardData[cardId].name = userName;
            cardData[cardId].role = userRole;
            
            // ä¿å­˜æ•¸æ“šåˆ°localStorage
            saveData();
            
            // é—œé–‰æ¨¡æ…‹æ¡†
            editModal.style.display = 'none';
            
            // æ›´æ–°å¡ç‰‡è¡¨æ ¼
            updateCardsTable();
            
            // æ›´æ–°ç‹€æ…‹
            statusEl.innerHTML = `<span style="color: #2ecc71;">å¡ç‰‡è³‡æ–™æ›´æ–°æˆåŠŸ</span>`;
        });
        
        // åˆªé™¤å¡ç‰‡
        deleteCardBtn.addEventListener('click', function() {
            const cardId = editCardIdEl.value;
            
            if (confirm(`ç¢ºå®šè¦åˆªé™¤å¡ç‰‡ ${cardId} çš„è³‡æ–™å—ï¼Ÿ`)) {
                // åˆªé™¤å¡ç‰‡æ•¸æ“š
                delete cardData[cardId];
                
                // å¾å·²è¨»å†Šå¡ç‰‡åˆ—è¡¨ä¸­ç§»é™¤
                registeredCards.delete(cardId);
                
                // ä¿å­˜æ•¸æ“šåˆ°localStorage
                saveData();
                
                // é—œé–‰æ¨¡æ…‹æ¡†
                editModal.style.display = 'none';
                
                // æ›´æ–°å¡ç‰‡è¡¨æ ¼å’Œçµ±è¨ˆ
                updateCardsTable();
                updateStats();
                
                // æ›´æ–°ç‹€æ…‹
                statusEl.innerHTML = `<span style="color: #e74c3c;">å¡ç‰‡è³‡æ–™å·²åˆªé™¤</span>`;
            }
        });
        
        // æ—¥æœŸç¯©é¸
        filterDateEl.addEventListener('change', updateRecordsTable);
        
        // ç”Ÿæˆæ—¥æ›†
        function generateCalendar(month, year) {
            calendarGridEl.innerHTML = '';
            
            // æ·»åŠ æ˜ŸæœŸæ¨™é¡Œ
            const weekdays = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            weekdays.forEach(day => {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day-header';
                dayEl.textContent = day;
                calendarGridEl.appendChild(dayEl);
            });
            
            // ç²å–ç•¶æœˆç¬¬ä¸€å¤©å’Œæœ€å¾Œä¸€å¤©
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const daysInMonth = lastDay.getDate();
            const startingDay = firstDay.getDay();
            
            // æ·»åŠ ä¸Šå€‹æœˆçš„æ—¥æœŸ
            const prevMonthLastDay = new Date(year, month, 0).getDate();
            for (let i = 0; i < startingDay; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month';
                dayEl.textContent = prevMonthLastDay - startingDay + i + 1;
                calendarGridEl.appendChild(dayEl);
            }
            
            // æ·»åŠ ç•¶æœˆæ—¥æœŸ
            for (let i = 1; i <= daysInMonth; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day';
                dayEl.textContent = i;
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯é€±æœ«
                const dayOfWeek = new Date(year, month, i).getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    dayEl.classList.add('weekend');
                }
                
                // æª¢æŸ¥æ˜¯å¦æœ‰æ‰“å¡è¨˜éŒ„
                const dateStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${i.toString().padStart(2, '0')}`;
                const dayRecords = attendanceRecords.filter(record => record.date === dateStr);
                
                if (dayRecords.length > 0) {
                    dayEl.classList.add('has-records');
                }
                
                // æª¢æŸ¥æ˜¯å¦æ˜¯é¸ä¸­çš„æ—¥æœŸ
                if (dateStr === selectedDate) {
                    dayEl.classList.add('active');
                }
                
                // æ·»åŠ é»æ“Šäº‹ä»¶
                dayEl.addEventListener('click', function() {
                    selectedDate = dateStr;
                    updateCalendar();
                    updateDayDetails(dateStr);
                });
                
                calendarGridEl.appendChild(dayEl);
            }
            
            // æ·»åŠ ä¸‹å€‹æœˆçš„æ—¥æœŸ
            const totalCells = 42; // 6è¡Œ x 7åˆ—
            const remainingCells = totalCells - (startingDay + daysInMonth);
            for (let i = 1; i <= remainingCells; i++) {
                const dayEl = document.createElement('div');
                dayEl.className = 'calendar-day other-month';
                dayEl.textContent = i;
                calendarGridEl.appendChild(dayEl);
            }
            
            // æ›´æ–°æœˆä»½æ¨™é¡Œ
            currentMonthEl.textContent = `${year}å¹´${month + 1}æœˆ`;
        }
        
        // æ›´æ–°æ—¥æ›†
        function updateCalendar() {
            generateCalendar(currentMonth, currentYear);
        }
        
        // æ›´æ–°æ—¥æœŸè©³æƒ…
        function updateDayDetails(date) {
            const dayRecords = attendanceRecords.filter(record => record.date === date);
            const uniqueCards = [...new Set(dayRecords.map(record => record.cardId))];
            const uniqueLocations = [...new Set(dayRecords.map(record => record.location))];
            
            // æ›´æ–°æ¨™é¡Œ
            selectedDateTitleEl.textContent = `${date} æ‰“å¡è©³æƒ…`;
            
            // æ›´æ–°æ‘˜è¦
            dayTotalEl.textContent = dayRecords.length;
            dayPresentEl.textContent = uniqueCards.length;
            dayLocationsEl.textContent = uniqueLocations.length;
            
            // æ›´æ–°è¨˜éŒ„åˆ—è¡¨
            dayRecordsEl.innerHTML = '';
            
            if (dayRecords.length === 0) {
                dayRecordsEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #7f8c8d;">ç•¶æ—¥ç„¡æ‰“å¡è¨˜éŒ„</div>';
                return;
            }
            
            dayRecords.forEach(record => {
                const recordEl = document.createElement('div');
                recordEl.className = 'day-record-item';
                
                recordEl.innerHTML = `
                    <div>
                        <strong>${record.name}</strong> (${record.role})
                    </div>
                    <div>
                        <span class="time-in">${record.timeIn || '--:--:--'}</span> - 
                        <span class="time-out">${record.timeOut || '--:--:--'}</span>
                    </div>
                    <div class="location">${record.location}</div>
                `;
                
                dayRecordsEl.appendChild(recordEl);
            });
        }
        
        // æœˆä»½å°èˆª
        prevMonthBtn.addEventListener('click', function() {
            currentMonth--;
            if (currentMonth < 0) {
                currentMonth = 11;
                currentYear--;
            }
            updateCalendar();
        });
        
        nextMonthBtn.addEventListener('click', function() {
            currentMonth++;
            if (currentMonth > 11) {
                currentMonth = 0;
                currentYear++;
            }
            updateCalendar();
        });
        
        // åˆå§‹åŒ–
        updateSystemStatus();
        updateRecordsTable();
        updateStats();
        updateCalendar();
        updateDayDetails(selectedDate);
        updateCardsTable();
        
        console.log("ç³»çµ±åˆå§‹åŒ–å®Œæˆ");
        console.log("ä½¿ç”¨èªªæ˜ï¼š");
        console.log("1. é»æ“Šã€å•Ÿå‹•æ‰“å¡ç³»çµ±ã€é–‹å§‹æ¥å—æ‰“å¡");
        console.log("2. åœ¨å¡ç‰‡IDè¼¸å…¥æ¡†ä¸­è¼¸å…¥å¡ç‰‡ID");
        console.log("3. é»æ“Šã€ç¢ºèªæ‰“å¡ã€æŒ‰éˆ•æˆ–æŒ‰Enteréµé€²è¡Œæ‰“å¡");
        console.log("4. é»æ“Šã€çµæŸæ‰“å¡ç³»çµ±ã€åœæ­¢æ¥å—æ‰“å¡");
        console.log("5. æ‰€æœ‰è³‡æ–™å·²ä½¿ç”¨localStorageä¿å­˜ï¼Œé—œé–‰ç€è¦½å™¨å¾Œä¸æœƒéºå¤±");
    </script>
</body>
</html>